<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drying Dashboard - Timber Predictor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .progress-bar-bg { background-color: #4a5568; }
        .progress-bar { background-color: #68d391; transition: width 0.5s ease-in-out; }
         #notification-area { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 50; display: flex; flex-direction: column; gap: 0.75rem; max-width: 320px; }
         .notification-toast { background-color: #10B981; color: white; padding: 1rem 1.25rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); font-size: 0.875rem; font-weight: 500; opacity: 0; transform: translateX(100%); transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); display: flex; align-items: center; gap: 0.5rem; }
         .notification-toast.show { opacity: 1; transform: translateX(0); }
         td a { min-width: 150px; }
         /* Tooltip */
        .tooltip { position: relative; display: inline-block; cursor: help; border-bottom: 1px dotted #9ca3af; /* gray-400 */}
        .tooltip .tooltiptext { visibility: hidden; width: 220px; background-color: #1f2937; /* gray-800 */ color: #fff; text-align: left; border-radius: 6px; padding: 8px 10px; position: absolute; z-index: 1; bottom: 135%; /* Position above the text */ left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; font-size: 0.75rem; font-weight: normal; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .tooltip .tooltiptext::after { /* Arrow */ content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #1f2937 transparent transparent transparent; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-xl border border-gray-200">
        <div class="mb-8 flex flex-col md:flex-row justify-between items-center gap-4 border-b pb-4 border-gray-200">
            <a href="/" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition duration-150 ease-in-out inline-flex items-center group">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5 group-hover:-translate-x-1 transition-transform" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                 Back to Predictor
            </a>
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 text-center">Active Drying Dashboard</h1>
            <div class="w-28 md:w-40"></div>
        </div>

        <div id="notification-area"></div>

        <h2 class="text-2xl font-semibold text-gray-700 mb-5">Currently Drying Batches</h2>
        <div id="jobs-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-12">
            <p id="loading-jobs" class="text-gray-500 col-span-full text-center py-10 text-lg">Loading active jobs...</p>
        </div>

        <div class="mt-12 pt-8 border-t border-gray-200">
             <div class="flex justify-between items-center mb-6">
                 <h2 class="text-2xl font-semibold text-gray-700">Complete Batches History</h2>
                 <!-- Batch ID Explanation Tooltip -->
                 <div class="tooltip text-sm text-gray-500">
                      Batch ID Format?
                      <span class="tooltiptext">Format: B&lt;YYMMDD&gt;&lt;NNN&gt;<br>YYMMDD = Date Started (Year, Month, Day)<br>NNN = Sequence number for that day (001, 002...)</span>
                 </div>
            </div>
            <div class="overflow-x-auto bg-white rounded-lg shadow border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-700 text-gray-100">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Batch ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Wood Species</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Start Time</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Initial Moisture</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Final Moisture</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Report</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body" class="bg-white divide-y divide-gray-200">
                        <tr id="loading-history-row">
                            <td colspan="6" class="px-6 py-10 text-center text-gray-500">Loading history...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const jobsContainer = document.getElementById('jobs-container');
        const loadingJobsP = document.getElementById('loading-jobs');
        const notificationArea = document.getElementById('notification-area');
        const historyTableBody = document.getElementById('history-table-body');
        const loadingHistoryRow = document.getElementById('loading-history-row');
        let displayedJobs = {};
        let notifiedJobs = new Set();

        function formatTimeRemaining(endTimeIso) {
            const now = new Date(); const end = new Date(endTimeIso);
            let totalSeconds = Math.max(0, (end - now) / 1000);
            if (totalSeconds === 0) return 'Ready';
            const days = Math.floor(totalSeconds / 86400); totalSeconds %= 86400;
            const hours = Math.floor(totalSeconds / 3600); totalSeconds %= 3600;
            let parts = [];
            if (days > 0) parts.push(`${days}d`);
            if (hours > 0) parts.push(`${hours}h`);
            return parts.join(' ') + ' Left' || '< 1h Left';
        }

        function calculateProgress(jobId, startTimeIso, endTimeIso) {
             const start = new Date(startTimeIso); const end = new Date(endTimeIso); const now = new Date();
             // console.log(`Job ${jobId}: Start=${start}, End=${end}, Now=${now}`);
             if (isNaN(start.getTime()) || isNaN(end.getTime())) { /* console.log(`Job ${jobId}: Invalid dates`); */ return '0'; }
             const totalDuration = (end - start);
             if (totalDuration <= 0) { /* console.log(`Job ${jobId}: Total duration <= 0`); */ return '100'; }
             const elapsedDuration = Math.max(0, (now < start ? 0 : now - start));
             const progress = Math.min(100, (elapsedDuration / totalDuration) * 100);
             const result = progress.toFixed(0);
             // console.log(`Job ${jobId}: Elapsed=${elapsedDuration}, Total=${totalDuration}, Progress=${progress.toFixed(2)}%, Result=${result}`);
             return (result === '0' && elapsedDuration > 0) ? '1' : result;
        }


        function showNotification(message) { /* ... (same code) ... */
            const toast = document.createElement('div'); toast.className = 'notification-toast';
            toast.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg><span>${message}</span>`;
            notificationArea.appendChild(toast); requestAnimationFrame(() => { toast.classList.add('show'); });
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => { if (notificationArea.contains(toast)) notificationArea.removeChild(toast); }, 500); }, 5000);
        }

        async function fetchAndDisplayJobs() {
            try {
                const response = await fetch('/get_active_jobs'); const jobs = await response.json();
                if (loadingJobsP) loadingJobsP.style.display = 'none';
                let currentJobIds = new Set();

                if (jobs.length === 0) { jobsContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center py-10 text-lg">No active drying jobs found.</p>'; displayedJobs = {}; return; }
                if (jobs.length > 0 && Object.keys(displayedJobs).length === 0 && jobsContainer.querySelector('p')) { jobsContainer.innerHTML = ''; }

                for (const job of jobs) {
                    currentJobIds.add(job.id);
                    const timeRemainingFormatted = formatTimeRemaining(job.end_time_iso);
                    const progressPercent = calculateProgress(job.id, job.start_time_iso, job.end_time_iso);
                    const cardId = `job-${job.id.replace(/[^a-zA-Z0-9]/g, '-')}`;

                    if (job.is_ready && !notifiedJobs.has(job.id)) { showNotification(`Batch ready: ${job.species} (${job.thickness} cm)`); notifiedJobs.add(job.id); }

                    let card = document.getElementById(cardId);
                    if (card) { // Update existing
                        card.querySelector('.time-remaining').textContent = timeRemainingFormatted;
                        const progressBar = card.querySelector('.progress-bar');
                        progressBar.style.width = `${progressPercent}%`;
                        progressBar.textContent = progressPercent > 5 ? `${progressPercent}%` : '';
                        // Update cost if needed (though it shouldn't change for active)
                        card.querySelector('.est-cost').textContent = `₹${job.estimated_cost}`;

                    } else { // Create new
                        card = document.createElement('div'); card.id = cardId;
                        card.className = 'job-card bg-gray-800 rounded-lg shadow-lg p-5 text-gray-200 transition-all duration-300 ease-in-out hover:shadow-xl transform hover:-translate-y-1';

                        card.innerHTML = `
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-xs font-semibold bg-gray-600 text-gray-100 px-2 py-0.5 rounded">${job.id || 'N/A'}</span>
                                <span class="text-xs text-gray-400 time-remaining">${timeRemainingFormatted}</span>
                            </div>
                            <h3 class="text-lg font-bold text-white mb-1 truncate" title="${job.species}">${job.species}</h3>
                            <p class="text-sm text-gray-400 mb-3">Thickness: ${job.thickness} cm</p>
                            <!-- NAYA: Cost Display -->
                            <p class="text-xs text-gray-300 mb-1">Simplified Est. Cost: <span class="font-semibold text-green-400 est-cost">₹${job.estimated_cost}</span></p>
                            <div class="text-xs text-gray-300 mb-1 mt-3">Progress:</div>
                            <div class="w-full progress-bar-bg rounded-full h-2.5 mb-4 overflow-hidden">
                                <div class="progress-bar h-2.5 rounded-full text-center text-white text-[10px] leading-none" style="width: ${progressPercent}%">${progressPercent > 5 ? `${progressPercent}%` : ''}</div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-400">
                                <span>Initial: ${job.initial_mc}%</span>
                                <span>Target: ${job.target_mc}%</span>
                            </div>`;
                        jobsContainer.appendChild(card); displayedJobs[job.id] = card;
                    }
                }
                // Remove old cards
                 for (const jobId in displayedJobs) { if (!currentJobIds.has(jobId)) { if (displayedJobs[jobId]) jobsContainer.removeChild(displayedJobs[jobId]); delete displayedJobs[jobId]; notifiedJobs.delete(jobId); } }
                 if (jobsContainer.children.length === 0 && !jobsContainer.querySelector('p')) { jobsContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center py-10 text-lg">No active drying jobs found.</p>'; }
            } catch (error) { console.error("Error fetching jobs:", error); if (loadingJobsP) loadingJobsP.style.display = 'none'; jobsContainer.innerHTML = '<p class="text-red-500 col-span-full text-center py-10 text-lg">Error loading active jobs.</p>'; }
        }

        async function fetchAndDisplayHistory() {
             try {
                 const response = await fetch('/get_history'); const historyJobs = await response.json();
                 if (loadingHistoryRow) loadingHistoryRow.style.display = 'none';
                 if (historyJobs.length === 0) { historyTableBody.innerHTML = '<tr id="loading-history-row"><td colspan="6" class="px-6 py-10 text-center text-gray-500">No completed batch history found yet.</td></tr>'; return; }
                 if (historyTableBody.contains(loadingHistoryRow)) { historyTableBody.innerHTML = ''; }

                 historyJobs.forEach(job => {
                      const rowId = `history-${job.batch_id.replace(/[^a-zA-Z0-9]/g, '-')}`;
                      if(document.getElementById(rowId)) return;
                      const row = document.createElement('tr'); row.id = rowId; row.className = 'hover:bg-gray-50 transition';
                      // Use TIMESTAMP for the PDF link
                      const reportLink = `/download_report/${encodeURIComponent(job.timestamp)}`;
                      row.innerHTML = `
                          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${job.batch_id}</td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${job.species}</td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${job.start_time}</td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${job.initial_moisture}%</td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${job.final_moisture}%</td>
                          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                              <a href="${reportLink}" target="_blank" class="text-green-600 hover:text-green-800 hover:underline inline-flex items-center text-xs px-3 py-1 bg-green-100 rounded-md transition hover:bg-green-200">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                                  Download Report
                              </a>
                          </td>
                      `;
                      historyTableBody.appendChild(row);
                 });
             } catch (error) { console.error("Error fetching history:", error); if (loadingHistoryRow) loadingHistoryRow.style.display = 'none'; historyTableBody.innerHTML = '<tr id="loading-history-row"><td colspan="6" class="px-6 py-10 text-center text-red-500">Error loading history data.</td></tr>'; }
        }

        // --- Run updates ---
        setInterval(fetchAndDisplayJobs, 5000); // Check jobs every 5 seconds
        setInterval(fetchAndDisplayHistory, 60000); // Check history every minute
        document.addEventListener('DOMContentLoaded', () => { fetchAndDisplayJobs(); fetchAndDisplayHistory(); });

    </script>

</body>
</html>

